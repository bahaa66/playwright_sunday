version: 0.2

env:
  parameter-store:
    GH_TOKEN: '/global/GH_TOKEN'
phases:
  install:
    runtime-versions:
      nodejs: 10
      docker: 18
    commands:
      - git clone --single-branch --branch master https://$GH_TOKEN@github.com/Cogility/cogynt-workstation-ingest.git tmp
      - mv tmp/.git ./
      - echo Setup Semantic Release
      - git clone  https://$GH_TOKEN@github.com/Cogility/semantic-release.git
      - sh ./semantic-release/installer.sh
      - echo Install Helm
      - curl -L https://git.io/get_helm.sh | bash
      - helm init --client-only
      - helm plugin install https://github.com/hypnoglow/helm-s3.git
      - helm repo add cogynt-helm-charts s3://cogynt-helm-charts/charts
  build:
    commands:
      - echo App Env set $BUILD_ENV
      - echo App Name set $APP_NAME
      - echo Run unit test - false
      - echo Build started on `date`
      - make build-image
  post_build:
    commands:
      - echo Pushing the Docker image...
      - make push-image
      - echo Pushing Github release
      - npx semantic-release --branch master --extends ./semantic-release/release-config.js
      - . ./.semver && echo Release Version set $RELEASE_VERSION
      - make push-semver
      - echo Push Helm Chart
      - helm package ./helm/$APP_NAME
      - helm s3 push --force ./$APP_NAME-$RELEASE_VERSION.tgz cogynt-helm-charts
      - echo Build completed on `date`
